<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NyxChan</title>
<link rel="icon" type="image/png" href="./img2.png">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: Arial, sans-serif;
  background: #f4ecd8;
  padding: 20px;
  color: #000;
  line-height: 1.6;
}
.container { max-width: 1200px; margin: 0 auto; }
#logo { 
  max-width: 300px; 
  display: block; 
  margin: 0 auto 20px;
}
h2 { color: #333; margin: 20px 0 10px; font-size: 1.4em; }
.section {
  background: #fff;
  border: 1px solid #ccc;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}
.thread {
  background: #fff;
  border: 1px solid #ccc;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.thread-header {
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 10px;
}
.thread-title {
  font-size: 1.2em;
  font-weight: bold;
  color: #800000;
  margin-bottom: 5px;
}
.thread-meta {
  font-size: 0.9em;
  color: #666;
}
.op-tag { color: #800000; font-weight: bold; }
.mod-tag { color: #ff0000; font-weight: bold; }
.post-image {
  max-width: 300px;
  max-height: 300px;
  display: block;
  margin: 10px 0;
  border: 1px solid #ccc;
  cursor: pointer;
  transition: transform 0.2s;
}
.post-image:hover { transform: scale(1.02); }
.reply-section {
  margin-left: 20px;
  border-left: 2px solid #ccc;
  padding-left: 15px;
  margin-top: 10px;
  background: #f9f9f9;
  padding: 10px;
  border-radius: 4px;
}
.reply-header {
  font-weight: bold;
  margin-bottom: 5px;
}
.hidden-replies { display: none; }
.read-more {
  color: #0066cc;
  cursor: pointer;
  text-decoration: underline;
  margin: 10px 0;
  display: inline-block;
  font-weight: bold;
}
.read-more:hover { color: #004499; }
.form-group {
  margin-bottom: 10px;
}
.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}
input[type="text"], input[type="password"], textarea {
  width: 100%;
  max-width: 500px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-family: Arial, sans-serif;
}
textarea {
  resize: vertical;
  min-height: 80px;
}
input[type="file"] {
  margin: 5px 0;
}
button {
  padding: 8px 16px;
  margin: 5px 5px 5px 0;
  background: #800000;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1em;
}
button:hover { background: #600000; }
button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
button.secondary {
  background: #666;
}
button.secondary:hover { background: #444; }
button.danger {
  background: #cc0000;
}
button.danger:hover { background: #990000; }
.login-buttons {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}
.status-bar {
  background: #e8d7b8;
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 20px;
  font-weight: bold;
}
.mod-controls {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #ccc;
}
.reply-form {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}
.reply-count {
  color: #666;
  font-size: 0.9em;
  margin-top: 5px;
}
.empty-state {
  text-align: center;
  color: #666;
  padding: 40px;
  font-style: italic;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 25px;
  border: 1px solid #888;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  animation: slideDown 0.3s;
}
@keyframes slideDown {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.modal-header {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 15px;
  color: #800000;
}
.modal-body {
  margin-bottom: 20px;
}
.modal-footer {
  text-align: right;
}
.modal-footer button {
  margin-left: 10px;
}
.loading {
  text-align: center;
  color: #666;
  padding: 20px;
}
</style>
</head>
<body>
<div class="container">
  <img id="logo" src="img.png" alt="NyxChan Logo">
  
  <div id="status-bar" class="status-bar" style="display:none;"></div>
  
  <div id="login-section" class="section">
    <h2>–í—Ö–æ–¥</h2>
    <div class="login-buttons">
      <button id="mod-btn">–í—Ö–æ–¥ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</button>
      <button id="user-btn" class="secondary">–í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
    </div>
  </div>

  <div id="create-thread-section" class="section" style="display:none;">
    <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç—Ä–µ–¥</h2>
    <div class="form-group">
      <label for="thread-nick">–í–∞—à –Ω–∏–∫:</label>
      <input type="text" id="thread-nick" placeholder="–ê–Ω–æ–Ω–∏–º">
    </div>
    <div class="form-group">
      <label for="thread-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–¥–∞:</label>
      <input type="text" id="thread-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
    </div>
    <div class="form-group">
      <label for="thread-text">–¢–µ–∫—Å—Ç:</label>
      <textarea id="thread-text" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..."></textarea>
    </div>
    <div class="form-group">
      <label for="thread-image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
      <input type="file" id="thread-image" accept="image/*">
    </div>
    <button id="new-thread-btn">–°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–¥</button>
  </div>

  <div id="threads-section" class="section">
    <h2>–¢—Ä–µ–¥—ã</h2>
    <div id="threads"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
  </div>
</div>

<div id="password-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">üîê –í—Ö–æ–¥ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</div>
    <div class="modal-body">
      <div class="form-group">
        <label for="mod-password-input">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
        <input type="password" id="mod-password-input" placeholder="–ü–∞—Ä–æ–ª—å">
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancel-password" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-password">–í–æ–π—Ç–∏</button>
    </div>
  </div>
</div>

<div id="confirm-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
    <div class="modal-body">
      <p id="confirm-message"></p>
    </div>
    <div class="modal-footer">
      <button id="cancel-confirm" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-confirm" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, push, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyBmH3-b1NzPDt4vhCaA89DLOCepKge5nag",
    authDomain: "nyxchan-65a73.firebaseapp.com",
    databaseURL: "https://nyxchan-65a73-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "nyxchan-65a73",
    storageBucket: "nyxchan-65a73.firebasestorage.app",
    messagingSenderId: "786040931352",
    appId: "1:786040931352:web:454255ab6863f11c53af6d"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let isMod = false;
let currentUser = null;
const MOD_PASSWORD = 'P7!dx92-LemFire';

function showModal(modalId) {
  document.getElementById(modalId).style.display = 'block';
}

function hideModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

function showConfirm(message, onConfirm) {
  document.getElementById('confirm-message').textContent = message;
  showModal('confirm-modal');
  
  const confirmBtn = document.getElementById('submit-confirm');
  const cancelBtn = document.getElementById('cancel-confirm');
  
  const newConfirmBtn = confirmBtn.cloneNode(true);
  const newCancelBtn = cancelBtn.cloneNode(true);
  
  confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
  cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
  
  newConfirmBtn.onclick = () => {
    hideModal('confirm-modal');
    onConfirm();
  };
  
  newCancelBtn.onclick = () => {
    hideModal('confirm-modal');
  };
}

window.onclick = (event) => {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
};

function generateUID() {
  return 'id' + Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
}

function showStatus(message, type = 'info') {
  const bar = document.getElementById('status-bar');
  bar.textContent = message;
  bar.style.display = 'block';
  bar.style.background = type === 'error' ? '#ffcccc' : '#e8d7b8';
  setTimeout(() => bar.style.display = 'none', 3000);
}

function login(asMod = false) {
  currentUser = {
    uid: generateUID(),
    nick: '–ê–Ω–æ–Ω–∏–º',
    isMod: asMod
  };
  isMod = asMod;
  
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('create-thread-section').style.display = 'block';
  
  const status = asMod ? 'üõ°Ô∏è –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  showStatus(status);
}

function loadThreads() {
  const threadsRef = ref(database, 'threads');
  
  onValue(threadsRef, (snapshot) => {
    const container = document.getElementById('threads');
    const data = snapshot.val();
    
    if (!data) {
      container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–¥–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
      return;
    }
    
    const threads = Object.entries(data).map(([id, thread]) => ({
      firebaseId: id,
      ...thread
    })).sort((a, b) => b.timestamp - a.timestamp);
    
    container.innerHTML = '';
    
    threads.forEach((thread) => {
      const threadDiv = document.createElement('div');
      threadDiv.className = 'thread';
      
      const nick = thread.nick || '–ê–Ω–æ–Ω–∏–º';
      
      let imgHtml = '';
      if (thread.image) {
        imgHtml = `<img class='post-image' src='${thread.image}' alt='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' onclick='window.open(this.src)' />`;
      }
      
      const modTag = thread.isMod ? '<span class="mod-tag">[MOD]</span> ' : '';
      const replyCount = thread.replies ? Object.keys(thread.replies).length : 0;
      
      threadDiv.innerHTML = `
        <div class="thread-header">
          <div class="thread-title">${escapeHtml(thread.title)}</div>
          <div class="thread-meta">
            ${modTag}<span class="op-tag">OP</span> <strong>${escapeHtml(nick)}</strong> 
            | ${new Date(thread.timestamp).toLocaleString('ru-RU')}
          </div>
        </div>
        <div>${escapeHtml(thread.text)}</div>
        ${imgHtml}
        <div class="reply-count">${replyCount} ${getRepliesWord(replyCount)}</div>
      `;
      
      const repliesContainer = document.createElement('div');
      
      if (thread.replies) {
        const repliesArray = Object.entries(thread.replies).map(([id, reply]) => ({
          firebaseId: id,
          ...reply
        })).sort((a, b) => a.timestamp - b.timestamp);
        
        repliesArray.forEach((reply, replyIndex) => {
          const replyDiv = document.createElement('div');
          replyDiv.className = 'reply-section';
          if (replyIndex >= 3) replyDiv.classList.add('hidden-replies');
          
          let replyImgHtml = '';
          if (reply.image) {
            replyImgHtml = `<img class='post-image' src='${reply.image}' alt='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' onclick='window.open(this.src)' />`;
          }
          
          const opTag = reply.uid === thread.uid ? '<span class="op-tag">(OP)</span> ' : '';
          const modTag = reply.isMod ? '<span class="mod-tag">[MOD]</span> ' : '';
          
          replyDiv.innerHTML = `
            <div class="reply-header">
              ${modTag}${opTag}<strong>${escapeHtml(reply.nick)}</strong> 
              | ${new Date(reply.timestamp).toLocaleString('ru-RU')}
            </div>
            <div>${escapeHtml(reply.text)}</div>
            ${replyImgHtml}
          `;
          
          if (isMod || (currentUser && reply.uid === currentUser.uid)) {
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
            deleteBtn.className = 'danger';
            deleteBtn.style.fontSize = '0.85em';
            deleteBtn.onclick = () => deleteReply(thread.firebaseId, reply.firebaseId);
            replyDiv.appendChild(deleteBtn);
          }
          
          repliesContainer.appendChild(replyDiv);
        });
        
        if (repliesArray.length > 3) {
          const readMore = document.createElement('span');
          readMore.className = 'read-more';
          readMore.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã (${repliesArray.length})`;
          readMore.onclick = () => {
            const hidden = repliesContainer.querySelectorAll('.hidden-replies');
            const isHidden = hidden[0].style.display !== 'block';
            hidden.forEach(r => r.style.display = isHidden ? 'block' : 'none');
            readMore.textContent = isHidden ? '–°–≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç—ã' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã (${repliesArray.length})`;
          };
          threadDiv.appendChild(repliesContainer);
          threadDiv.appendChild(readMore);
        } else {
          threadDiv.appendChild(repliesContainer);
        }
      }
      
      if (currentUser) {
        const replyForm = document.createElement('div');
        replyForm.className = 'reply-form';
        replyForm.innerHTML = `
          <div class="form-group">
            <input type="text" class="reply-nick" placeholder="–ê–Ω–æ–Ω–∏–º">
          </div>
          <div class="form-group">
            <textarea class="reply-text" rows="3" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞"></textarea>
          </div>
          <div class="form-group">
            <input type="file" class="reply-image" accept="image/*">
          </div>
        `;
        
        const replyBtn = document.createElement('button');
        replyBtn.textContent = 'üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å';
        replyBtn.onclick = () => addReply(thread.firebaseId, thread.uid, replyForm);
        replyForm.appendChild(replyBtn);
        
        threadDiv.appendChild(replyForm);
      }
      
      if (isMod || (currentUser && thread.uid === currentUser.uid)) {
        const modControls = document.createElement('div');
        modControls.className = 'mod-controls';
        
        const deleteThreadBtn = document.createElement('button');
        deleteThreadBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–¥';
        deleteThreadBtn.className = 'danger';
        deleteThreadBtn.onclick = () => deleteThread(thread.firebaseId);
        
        modControls.appendChild(deleteThreadBtn);
        threadDiv.appendChild(modControls);
      }
      
      container.appendChild(threadDiv);
    });
  });
}

function addReply(threadId, threadUid, formDiv) {
  const nick = formDiv.querySelector('.reply-nick').value.trim() || '–ê–Ω–æ–Ω–∏–º';
  const text = formDiv.querySelector('.reply-text').value.trim();
  const imageInput = formDiv.querySelector('.reply-image');
  
  if (!text) {
    showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞!', 'error');
    return;
  }
  
  const reply = {
    nick: nick,
    text: text,
    uid: currentUser.uid,
    isMod: isMod,
    timestamp: Date.now(),
    image: null
  };
  
  if (imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      reply.image = e.target.result;
      const replyRef = push(ref(database, `threads/${threadId}/replies`));
      set(replyRef, reply);
      showStatus('–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
    };
    reader.readAsDataURL(imageInput.files[0]);
  } else {
    const replyRef = push(ref(database, `threads/${threadId}/replies`));
    set(replyRef, reply);
    showStatus('–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
  }
}

function createThread() {
  const title = document.getElementById('thread-title').value.trim();
  const text = document.getElementById('thread-text').value.trim();
  const nick = document.getElementById('thread-nick').value.trim() || '–ê–Ω–æ–Ω–∏–º';
  const imageInput = document.getElementById('thread-image');
  
  if (!title || !text) {
    showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç —Ç—Ä–µ–¥–∞!', 'error');
    return;
  }
  
  const thread = {
    title: title,
    text: text,
    nick: nick,
    uid: currentUser.uid,
    isMod: isMod,
    timestamp: Date.now(),
    image: null
  };
  
  if (imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      thread.image = e.target.result;
      const threadRef = push(ref(database, 'threads'));
      set(threadRef, thread);
      showStatus('–¢—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω!');
      
      document.getElementById('thread-title').value = '';
      document.getElementById('thread-text').value = '';
      document.getElementById('thread-image').value = '';
    };
    reader.readAsDataURL(imageInput.files[0]);
  } else {
    const threadRef = push(ref(database, 'threads'));
    set(threadRef, thread);
    showStatus('–¢—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω!');
    
    document.getElementById('thread-title').value = '';
    document.getElementById('thread-text').value = '';
  }
}

function deleteThread(threadId) {
  showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—Ä–µ–¥?', () => {
    remove(ref(database, `threads/${threadId}`));
    showStatus('–¢—Ä–µ–¥ —É–¥–∞–ª–µ–Ω!');
  });
}

function deleteReply(threadId, replyId) {
  showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç?', () => {
    remove(ref(database, `threads/${threadId}/replies/${replyId}`));
    showStatus('–û—Ç–≤–µ—Ç —É–¥–∞–ª–µ–Ω!');
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getRepliesWord(count) {
  if (count % 10 === 1 && count % 100 !== 11) return '–æ—Ç–≤–µ—Ç';
  if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return '–æ—Ç–≤–µ—Ç–∞';
  return '–æ—Ç–≤–µ—Ç–æ–≤';
}

document.getElementById('mod-btn').onclick = () => {
  showModal('password-modal');
  document.getElementById('mod-password-input').value = '';
  document.getElementById('mod-password-input').focus();
};

document.getElementById('submit-password').onclick = () => {
  const pass = document.getElementById('mod-password-input').value;
  if (pass === MOD_PASSWORD) {
    hideModal('password-modal');
    login(true);
  } else {
    showStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', 'error');
    document.getElementById('mod-password-input').value = '';
    document.getElementById('mod-password-input').focus();
  }
};

document.getElementById('cancel-password').onclick = () => {
  hideModal('password-modal');
};

document.getElementById('mod-password-input').onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('submit-password').click();
  }
};

document.getElementById('user-btn').onclick = () => {
  login(false);
};

document.getElementById('new-thread-btn').onclick = createThread;

loadThreads();
</script>
</body>
</html>
