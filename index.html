<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NyxChan</title>
<style>
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
  font-family: Arial, sans-serif;
  background: #f4ecd8;
  padding: 20px;
  color: #000;
  line-height: 1.6;
  transition: background-color 0.3s, color 0.3s;
}

body.dark-theme {
  background: #1a1a1a;
  color: #ffffff;
}

body.dark-theme .section,
body.dark-theme .thread {
  background: #2d2d2d;
  border-color: #444;
  color: #ffffff;
}

body.dark-theme .thread-header {
  border-color: #444;
}

body.dark-theme .thread-title {
  color: #ff6b6b;
}

body.dark-theme .reply-section {
  background: #3a3a3a;
  border-color: #555;
}

body.dark-theme input[type="text"],
body.dark-theme input[type="password"],
body.dark-theme textarea {
  background: #3a3a3a;
  color: #ffffff;
  border-color: #555;
}

body.dark-theme .modal-content {
  background: #2d2d2d;
  color: #ffffff;
  border-color: #444;
}

body.dark-theme .status-bar {
  background: #3a3a3a;
  color: #ffffff;
  border: 1px solid #555;
}

body.dark-theme .captcha-display {
  background: #3a3a3a;
  color: #ffffff;
  border-color: #555;
}

body.dark-theme .captcha-container {
  background: #2d2d2d;
  border-color: #555;
}

body.dark-theme .thread-meta {
  color: #aaa;
}

body.dark-theme .reply-count {
  color: #aaa;
}

body.dark-theme h2 {
  color: #ffffff;
}

body.dark-theme .form-group label {
  color: #ffffff;
}

body.dark-theme .empty-state,
body.dark-theme .loading {
  color: #aaa;
}

.container {
max-width: 1200px;
margin: 0 auto;
}

body.dark-theme .container {
  background: transparent;
}

h2 {
color: #333;
margin: 20px 0 10px;
font-size: 1.4em;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #000;
}

.section {
  background: #fff;
  border: 1px solid #ccc;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}

.thread {
  background: #fff;
  border: 1px solid #ccc;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.thread-header {
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 10px;
}

.thread-title {
  font-size: 1.2em;
  font-weight: bold;
  color: #800000;
  margin-bottom: 5px;
}

.thread-meta {
  font-size: 0.9em;
  color: #666;
}

.reply-count {
  color: #666;
  font-size: 0.9em;
  margin-top: 5px;
}

.op-tag {
color: #800000;
font-weight: bold;
}

.mod-tag {
color: #ff0000;
font-weight: bold;
}

.tester-tag {
color: #008800;
font-weight: bold;
}

.captcha-container {
  background: #f0f0f0;
  padding: 15px;
  border-radius: 4px;
  margin: 15px 0;
  border: 2px solid #ccc;
}

.captcha-display {
  background: #fff;
  padding: 20px;
  text-align: center;
  font-size: 3em;
  font-weight: bold;
  letter-spacing: 12px;
  font-family: 'Courier New', monospace;
  color: #333;
  text-decoration: line-through;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  border: 1px solid #999;
  margin-bottom: 10px;
  user-select: none;
}

.captcha-input {
  width: 100%;
  max-width: 200px;
  padding: 10px;
  font-size: 1.1em;
  text-align: center;
  letter-spacing: 4px;
  text-transform: uppercase;
}

.captcha-refresh {
  margin-left: 10px;
  padding: 10px 15px;
  font-size: 1.2em;
  cursor: pointer;
  vertical-align: bottom;
  margin-bottom: -5px;
}

.logout-btn {
  padding: 10px 20px;
  background: #800000;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  display: none;
  margin-bottom: 20px;
}

.logout-btn:hover {
  background: #600000;
}

.header-controls {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 10px;
}

.post-image {
  max-width: 300px;
  max-height: 300px;
  display: block;
  margin: 10px 0;
  border: 1px solid #ccc;
  cursor: pointer;
  transition: transform 0.2s;
}

body.dark-theme .post-image {
  border: 1px solid #555;
}

.post-image:hover {
transform: scale(1.02);
}

.post-video {
  max-width: 500px;
  max-height: 400px;
  display: block;
  margin: 10px 0;
  border: 1px solid #ccc;
  border-radius: 4px;
}

body.dark-theme .post-video {
  border: 1px solid #555;
}

.reply-section {
  margin-left: 20px;
  border-left: 2px solid #ccc;
  padding-left: 15px;
  margin-top: 10px;
  background: #f9f9f9;
  padding: 10px;
  border-radius: 4px;
}

.reply-header {
  font-weight: bold;
  margin-bottom: 5px;
}

.hidden-replies {
display: none;
}

.read-more {
  color: #0066cc;
  cursor: pointer;
  text-decoration: underline;
  margin: 10px 0;
  display: inline-block;
  font-weight: bold;
}

.read-more:hover {
color: #004499;
}

.form-group {
  margin-bottom: 10px;
}

input[type="text"],
input[type="password"],
textarea {
  width: 100%;
  max-width: 500px;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-family: Arial, sans-serif;
}

body.dark-theme input[type="text"],
body.dark-theme input[type="password"],
body.dark-theme textarea {
  background: #3a3a3a;
  color: #ffffff;
  border: 1px solid #555;
}

textarea {
  resize: vertical;
  min-height: 80px;
}

input[type="file"] {
  margin: 5px 0;
}

body.dark-theme input[type="file"] {
  color: #ffffff;
}

button {
  padding: 8px 16px;
  margin: 5px 5px 5px 0;
  background: #800000;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1em;
}

button:hover {
background: #600000;
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

button.secondary {
  background: #666;
}

button.secondary:hover {
background: #444;
}

button.danger {
  background: #cc0000;
}

button.danger:hover {
background: #990000;
}

.login-buttons {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}

.status-bar {
  background: #e8d7b8;
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 20px;
  font-weight: bold;
}

.mod-controls {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #ccc;
}

body.dark-theme .mod-controls {
  border-top-color: #555;
}

.reply-form {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

body.dark-theme .reply-form {
  border-top-color: #555;
}

.empty-state {
  text-align: center;
  color: #666;
  padding: 40px;
  font-style: italic;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s;
  overflow: hidden;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 25px;
  border: 1px solid #888;
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  animation: slideDown 0.3s;
  position: relative;
}

@keyframes slideDown {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 15px;
  color: #800000;
}

.modal-body {
  margin-bottom: 20px;
}

.modal-footer {
  text-align: right;
}

.modal-footer button {
  margin-left: 10px;
}

.loading {
  text-align: center;
  color: #666;
  padding: 20px;
}

.settings-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.5em;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 999;
}

.theme-selector {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.theme-option {
  flex: 1;
  padding: 15px;
  border: 2px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.3s;
}

.theme-option:hover {
  border-color: #800000;
  transform: scale(1.05);
}

.theme-option.active {
  border-color: #800000;
  background: #800000;
  color: white;
}

.theme-preview {
  width: 60px;
  height: 40px;
  margin: 0 auto 10px;
  border-radius: 4px;
  border: 1px solid #333;
}

.theme-preview.light {
  background: linear-gradient(to bottom, #f4ecd8 50%, #fff 50%);
}

.theme-preview.dark {
  background: linear-gradient(to bottom, #1a1a1a 50%, #2d2d2d 50%);
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 10px 0;
  padding: 8px;
  background: rgba(128, 0, 0, 0.05);
  border-radius: 4px;
}

body.dark-theme .checkbox-group {
  background: rgba(255, 107, 107, 0.1);
}

.checkbox-group input[type="checkbox"] {
  width: auto;
  cursor: pointer;
}

.checkbox-group label {
  margin: 0;
  cursor: pointer;
  font-weight: normal;
  user-select: none;
}

#boards-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

body.dark-theme #boards-selector {
  border-bottom-color: #444;
}

.board-tab {
  padding: 8px 16px;
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9em;
}

.board-tab:hover {
  background: #e0e0e0;
  border-color: #999;
}

.board-tab.active {
  background: #800000;
  color: white;
  border-color: #600000;
}

.board-tab .board-code {
  font-weight: bold;
}

.board-tab .board-desc {
  font-size: 0.85em;
  opacity: 0.8;
  margin-left: 5px;
}

.mod-boards-controls {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

body.dark-theme .mod-boards-controls {
  border-top-color: #444;
}

.board-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px;
  border-radius: 4px;
  transition: background 0.2s;
}

.board-item:hover {
  background: rgba(0,0,0,0.05);
}

body.dark-theme .board-item:hover {
  background: rgba(255,255,255,0.05);
}

.board-item .board-actions {
  margin-left: auto;
  display: flex;
  gap: 5px;
  opacity: 0;
  transition: opacity 0.2s;
}

.board-item:hover .board-actions {
  opacity: 1;
}

.board-item button {
  padding: 4px 8px;
  font-size: 0.8em;
  margin: 0;
}

</style>
</head>
<body>
<button id="settings-btn" class="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>

<div class="container">
  <img id="logo" src="img.png" alt="NyxChan Logo" style="max-width: 300px; display: block; margin: 0 auto 20px;">
  
  <div class="header-controls">
    <button id="logout-btn" class="logout-btn">üö™ –í—ã–π—Ç–∏</button>
  </div>
  
  <div id="status-bar" class="status-bar" style="display:none;"></div>
  
  <div id="login-section" class="section">
    <h2>–í—Ö–æ–¥</h2>
    <div class="login-buttons">
      <button id="mod-btn">–í—Ö–æ–¥ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</button>
      <button id="user-btn" class="secondary">–í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
    </div>
  </div>

  <div id="create-thread-section" class="section" style="display:none;">
    <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç—Ä–µ–¥</h2>
    <div class="form-group">
      <label for="thread-nick">–í–∞—à –Ω–∏–∫:</label>
      <input type="text" id="thread-nick" placeholder="–ê–Ω–æ–Ω–∏–º">
    </div>
    <div class="form-group">
      <label for="thread-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–¥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
      <input type="text" id="thread-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
    </div>
    <div class="form-group">
      <label for="thread-text">–¢–µ–∫—Å—Ç:</label>
      <textarea id="thread-text" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..."></textarea>
    </div>
    <div class="form-group">
      <label for="thread-image">–ú–µ–¥–∏–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
      <input type="file" id="thread-image" accept="image/*,video/mp4,video/webm,image/gif">
    </div>
    <div id="thread-hide-mod-checkbox" style="display:none;" class="checkbox-group">
      <input type="checkbox" id="thread-hide-mod">
      <label for="thread-hide-mod">üé≠ –°–∫—Ä—ã—Ç—å –ø—Ä–∏–ø–∏—Å–∫—É –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞?</label>
    </div>
    <button id="new-thread-btn">–°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–¥</button>
  </div>

<div id="threads-section" class="section">
    <h2 id="current-board-title">–¢—Ä–µ–¥—ã</h2>
    <div id="boards-selector"></div>
    <div id="threads"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
  </div>
</div>

<div id="settings-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="modal-body">
      <h3 style="margin-bottom: 10px;">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
      <div class="theme-selector">
        <div class="theme-option" data-theme="light">
          <div class="theme-preview light"></div>
          <div>–°–≤–µ—Ç–ª–∞—è</div>
        </div>
        <div class="theme-option" data-theme="dark">
          <div class="theme-preview dark"></div>
          <div>–¢–µ–º–Ω–∞—è</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="close-settings" class="secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<div id="captcha-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–ø—á–∏</div>
    <div class="modal-body">
      <div class="captcha-container">
        <label>–í–≤–µ–¥–∏—Ç–µ –∫–∞–ø—á—É:</label>
        <div id="modal-captcha-display" class="captcha-display"></div>
        <div>
          <input type="text" id="modal-captcha-input" class="captcha-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥">
          <button type="button" id="modal-refresh-captcha" class="captcha-refresh">üîÑ</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancel-captcha" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-captcha">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="password-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">üîí –í—Ö–æ–¥ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</div>
    <div class="modal-body">
      <div class="form-group">
        <label for="mod-password-input">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
        <input type="password" id="mod-password-input" placeholder="–ü–∞—Ä–æ–ª—å">
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancel-password" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-password">–í–æ–π—Ç–∏</button>
    </div>
  </div>
</div>

<div id="confirm-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
    <div class="modal-body">
      <p id="confirm-message"></p>
    </div>
    <div class="modal-footer">
      <button id="cancel-confirm" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-confirm" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="create-board-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">üìã –°–æ–∑–¥–∞—Ç—å –±–æ—Ä–¥—É</div>
    <div class="modal-body">
      <div class="form-group">
        <label for="board-name-input">–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ä–¥—ã:</label>
        <input type="text" id="board-name-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: b, a, mu">
      </div>
      <div class="form-group">
        <label for="board-title-input">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <input type="text" id="board-title-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—Ä–µ–¥">
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancel-create-board" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-create-board">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<div id="edit-board-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ä–¥—É</div>
    <div class="modal-body">
      <input type="hidden" id="edit-board-id">
      <div class="form-group">
        <label for="edit-board-name">–ö–æ–¥ –±–æ—Ä–¥—ã:</label>
        <input type="text" id="edit-board-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: b">
      </div>
      <div class="form-group">
        <label for="edit-board-title">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
        <input type="text" id="edit-board-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—Ä–µ–¥">
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancel-edit-board" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-edit-board">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="delete-board-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –±–æ—Ä–¥—É</div>
    <div class="modal-body">
      <input type="hidden" id="delete-board-id">
      <p id="delete-board-message">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –±–æ—Ä–¥—É? –í—Å–µ —Ç—Ä–µ–¥—ã –Ω–∞ –Ω–µ–π —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!</p>
    </div>
    <div class="modal-footer">
      <button id="cancel-delete-board" class="secondary">–û—Ç–º–µ–Ω–∞</button>
      <button id="submit-delete-board" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, push, set, onValue, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyBmH3-b1NzPDt4vhCaA89DLOCepKge5nag",
    authDomain: "nyxchan-65a73.firebaseapp.com",
    databaseURL: "https://nyxchan-65a73-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "nyxchan-65a73",
    storageBucket: "nyxchan-65a73.firebasestorage.app",
    messagingSenderId: "786040931352",
    appId: "1:786040931352:web:454255ab6863f11c53af6d"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let isMod = false;
let currentUser = null;
let currentCaptcha = '';
let captchaCallback = null;
let currentTheme = localStorage.getItem('theme') || 'light';
let currentBoard = localStorage.getItem('currentBoard') || 'all';
let boardsRequestId = 0;
const MOD_PASSWORD = 'P7!dx92-LemFire';

function applyTheme(theme) {
  currentTheme = theme;
  if (theme === 'dark') {
    document.body.classList.add('dark-theme');
  } else {
    document.body.classList.remove('dark-theme');
  }
  localStorage.setItem('theme', theme);
  updateThemeSelector();
}

function updateThemeSelector() {
  document.querySelectorAll('.theme-option').forEach(option => {
    if (option.dataset.theme === currentTheme) {
      option.classList.add('active');
    } else {
      option.classList.remove('active');
    }
  });
}

function isTester() {
  return window.location.hostname === '127.0.0.1' && window.location.port === '17414';
}

function generateCaptcha() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let captcha = '';
  for (let i = 0; i < 6; i++) {
    captcha += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  currentCaptcha = captcha;
  document.getElementById('modal-captcha-display').textContent = captcha;
  document.getElementById('modal-captcha-input').value = '';
}

function showCaptchaModal(callback) {
  captchaCallback = callback;
  generateCaptcha();
  
  const scrollY = window.scrollY;
  
  showModal('captcha-modal');
  document.body.style.overflow = 'hidden';
  document.body.style.position = 'fixed';
  document.body.style.top = `-${scrollY}px`;
  document.body.style.width = '100%';
  
  setTimeout(() => {
    const input = document.getElementById('modal-captcha-input');
    if (input) {
      input.focus();
    }
  }, 100);
}

function verifyCaptcha() {
  const userInput = document.getElementById('modal-captcha-input').value.toUpperCase();
  return userInput === currentCaptcha;
}

function showModal(modalId) {
  document.getElementById(modalId).style.display = 'block';
}

function hideModal(modalId) {
  const scrollY = document.body.style.top;
  
  document.getElementById(modalId).style.display = 'none';
  document.body.style.overflow = '';
  document.body.style.position = '';
  document.body.style.top = '';
  document.body.style.width = '';
  
  if (scrollY) {
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
  }
}

function showConfirm(message, onConfirm) {
  document.getElementById('confirm-message').textContent = message;
  showModal('confirm-modal');
  
  const confirmBtn = document.getElementById('submit-confirm');
  const cancelBtn = document.getElementById('cancel-confirm');
  
  const newConfirmBtn = confirmBtn.cloneNode(true);
  const newCancelBtn = cancelBtn.cloneNode(true);
  
  confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
  cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
  
  newConfirmBtn.onclick = () => {
    hideModal('confirm-modal');
    onConfirm();
  };
  
  newCancelBtn.onclick = () => {
    hideModal('confirm-modal');
  };
}

window.onclick = (event) => {
  if (event.target.classList.contains('modal')) {
    const modalId = event.target.id;
    hideModal(modalId);
    if (modalId === 'captcha-modal') {
      captchaCallback = null;
    }
  }
};

function generateUID() {
  return 'id' + Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
}

function saveUserSession() {
  if (currentUser) {
    localStorage.setItem('userSession', JSON.stringify({
      uid: currentUser.uid,
      nick: currentUser.nick,
      isMod: currentUser.isMod,
      isTester: currentUser.isTester
    }));
  }
}

function loadUserSession() {
  const session = localStorage.getItem('userSession');
  if (session) {
    try {
      const data = JSON.parse(session);
      currentUser = {
        uid: data.uid,
        nick: data.nick,
        isMod: data.isMod,
        isTester: data.isTester
      };
      isMod = data.isMod;
      return true;
    } catch (e) {
      localStorage.removeItem('userSession');
    }
  }
  return false;
}

function logout() {
  localStorage.removeItem('userSession');
  currentUser = null;
  isMod = false;
  
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('create-thread-section').style.display = 'none';
  document.getElementById('logout-btn').style.display = 'none';
  
  loadThreads();
}

function showStatus(message, type = 'info') {
  const bar = document.getElementById('status-bar');
  bar.textContent = message;
  bar.style.display = 'block';
  
  if (document.body.classList.contains('dark-theme')) {
    bar.style.background = type === 'error' ? '#8b0000' : '#3a3a3a';
    bar.style.color = '#ffffff';
    bar.style.border = '1px solid #555';
  } else {
    bar.style.background = type === 'error' ? '#ffcccc' : '#e8d7b8';
    bar.style.color = '#000';
    bar.style.border = '1px solid transparent';
  }
  
  setTimeout(() => bar.style.display = 'none', 3000);
}

function login(asMod = false) {
  currentUser = {
    uid: generateUID(),
    nick: '–ê–Ω–æ–Ω–∏–º',
    isMod: asMod,
    isTester: isTester()
  };
  isMod = asMod;
  
  saveUserSession();
  
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('create-thread-section').style.display = 'block';
  document.getElementById('logout-btn').style.display = 'block';
  
  if (isMod) {
    document.getElementById('thread-hide-mod-checkbox').style.display = 'block';
  } else {
    document.getElementById('thread-hide-mod-checkbox').style.display = 'none';
  }
  
  loadThreads();
}

function canDeletePost(postUid) {
  if (!currentUser) return false;
  if (isMod) return true;
  return postUid === currentUser.uid;
}

function selectBoard(boardId) {
  currentBoard = boardId;
  localStorage.setItem('currentBoard', boardId);
  loadThreads();
}

function updateBoardsSelector() {
  const container = document.getElementById('boards-selector');
  const requestId = ++boardsRequestId;
  
  let html = `<div class="board-tab ${currentBoard === 'all' ? 'active' : ''}" onclick="selectBoard('all')">
    <span class="board-code">/all/</span>
    <span class="board-desc">–í—Å–µ —Ç—Ä–µ–¥—ã</span>
  </div>`;
  
  container.innerHTML = html;
  
  get(ref(database, 'boards')).then((snapshot) => {
    if (requestId !== boardsRequestId) return;
    
    const boards = snapshot.val() || {};
    const boardsArray = Object.entries(boards).map(([id, board]) => ({
      id,
      ...board
    })).sort((a, b) => (a.order || 0) - (b.order || 0));
    
    let html = `<div class="board-tab ${currentBoard === 'all' ? 'active' : ''}" onclick="selectBoard('all')">
      <span class="board-code">/all/</span>
      <span class="board-desc">–í—Å–µ —Ç—Ä–µ–¥—ã</span>
    </div>`;
    
    boardsArray.forEach(board => {
      html += `<div class="board-tab ${currentBoard === board.id ? 'active' : ''}" onclick="selectBoard('${board.id}')">
        <span class="board-code">/${board.code}/</span>
        <span class="board-desc">${escapeHtml(board.title || '')}</span>
      </div>`;
    });
    
    if (isMod) {
      html += `<div class="board-tab" onclick="showCreateBoardModal()" style="background: #4a4; border-color: #282;">
        <span class="board-code">+</span>
      </div>`;
      
      html += `<div class="mod-boards-controls">
        <h4 style="margin-bottom: 10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ä–¥–∞–º–∏:</h4>`;
      
      boardsArray.forEach(board => {
        html += `<div class="board-item">
          <span>/${board.code}/ - ${escapeHtml(board.title || '')}</span>
          <div class="board-actions">
            <button onclick="showEditBoardModal('${board.id}', '${board.code}', '${escapeHtml(board.title || '')}')">‚úèÔ∏è</button>
            <button class="danger" onclick="showDeleteBoardModal('${board.id}')">üóëÔ∏è</button>
          </div>
        </div>`;
      });
      
      html += `</div>`;
    }
    
    container.innerHTML = html;
    
    const titleEl = document.getElementById('current-board-title');
    if (currentBoard === 'all') {
      titleEl.textContent = '–í—Å–µ —Ç—Ä–µ–¥—ã';
    } else {
      const currentBoardData = boardsArray.find(b => b.id === currentBoard);
      if (currentBoardData) {
        titleEl.textContent = `/${currentBoardData.code}/ - ${currentBoardData.title || ''}`;
      } else {
        titleEl.textContent = '–¢—Ä–µ–¥—ã';
      }
    }
  }).catch(() => {
    if (requestId !== boardsRequestId) return;
    container.innerHTML = `<div class="board-tab active" onclick="selectBoard('all')">
      <span class="board-code">/all/</span>
      <span class="board-desc">–í—Å–µ —Ç—Ä–µ–¥—ã</span>
    </div>`;
  });
}

window.selectBoard = selectBoard;
window.showCreateBoardModal = showCreateBoardModal;
window.showEditBoardModal = showEditBoardModal;
window.showDeleteBoardModal = showDeleteBoardModal;

function showCreateBoardModal() {
  document.getElementById('board-name-input').value = '';
  document.getElementById('board-title-input').value = '';
  showModal('create-board-modal');
  document.getElementById('board-name-input').focus();
}

function showEditBoardModal(id, code, title) {
  document.getElementById('edit-board-id').value = id;
  document.getElementById('edit-board-name').value = code;
  document.getElementById('edit-board-title').value = title;
  showModal('edit-board-modal');
  document.getElementById('edit-board-name').focus();
}

function showDeleteBoardModal(id) {
  document.getElementById('delete-board-id').value = id;
  showModal('delete-board-modal');
}

function createBoard() {
  const code = document.getElementById('board-name-input').value.trim().toLowerCase();
  const title = document.getElementById('board-title-input').value.trim();
  
  if (!code) {
    showStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–æ—Ä–¥—ã!', 'error');
    return;
  }
  
  const boardRef = push(ref(database, 'boards'));
  set(boardRef, {
    code: code,
    title: title,
    order: Date.now()
  });
  
  hideModal('create-board-modal');
  showStatus('–ë–æ—Ä–¥–∞ —Å–æ–∑–¥–∞–Ω–∞!');
  updateBoardsSelector();
}

function editBoard() {
  const id = document.getElementById('edit-board-id').value;
  const code = document.getElementById('edit-board-name').value.trim().toLowerCase();
  const title = document.getElementById('edit-board-title').value.trim();
  
  if (!code) {
    showStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–æ—Ä–¥—ã!', 'error');
    return;
  }
  
  set(ref(database, `boards/${id}`), {
    code: code,
    title: title,
    order: Date.now()
  });
  
  hideModal('edit-board-modal');
  showStatus('–ë–æ—Ä–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
  updateBoardsSelector();
}

function deleteBoard() {
  const id = document.getElementById('delete-board-id').value;
  
  get(ref(database, 'boards')).then((snapshot) => {
    const boards = snapshot.val() || {};
    
    remove(ref(database, `boards/${id}`));
    
    get(ref(database, 'threads')).then((threadSnapshot) => {
      const threads = threadSnapshot.val() || {};
      Object.entries(threads).forEach(([threadId, thread]) => {
        if (thread.board === id) {
          remove(ref(database, `threads/${threadId}`));
        }
      });
    });
    
    hideModal('delete-board-modal');
    showStatus('–ë–æ—Ä–¥–∞ —É–¥–∞–ª–µ–Ω–∞!');
    
    if (currentBoard === id) {
      selectBoard('all');
    } else {
      updateBoardsSelector();
    }
  });
}

function initDefaultBoard() {
  get(ref(database, 'boards')).then((snapshot) => {
    const boards = snapshot.val();
    if (!boards || Object.keys(boards).length === 0) {
      const randomTitle = Math.random().toString(36).substring(2, 8);
      const defaultBoardRef = push(ref(database, 'boards'));
      set(defaultBoardRef, {
        code: 'b',
        title: randomTitle,
        order: 0
      });
    }
  });
}

function loadThreads() {
  const threadsRef = ref(database, 'threads');
  
  onValue(threadsRef, (snapshot) => {
    const container = document.getElementById('threads');
    const data = snapshot.val();
    
    if (!data) {
      container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–¥–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
      return;
    }
    
    let threads = Object.entries(data).map(([id, thread]) => ({
      firebaseId: id,
      ...thread
    }));
    
    if (currentBoard !== 'all') {
      threads = threads.filter(t => t.board === currentBoard);
    }
    
    threads.sort((a, b) => b.timestamp - a.timestamp);
    
    if (threads.length === 0) {
      container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–¥–æ–≤ –Ω–∞ —ç—Ç–æ–π –±–æ—Ä–¥–µ.</div>';
      return;
    }
    
    container.innerHTML = '';
    
    threads.forEach((thread) => {
      const threadDiv = document.createElement('div');
      threadDiv.className = 'thread';
      
      const nick = thread.nick || '–ê–Ω–æ–Ω–∏–º';
      
      const modTag = (thread.isMod && !thread.hideMod) ? '<span class="mod-tag">[MOD]</span> ' : '';
      const testerTag = thread.isTester ? '<span class="tester-tag">[TESTER]</span> ' : '';
      const replyCount = thread.replies ? Object.keys(thread.replies).length : 0;
      
      let mediaHtml = '';
      if (thread.image) {
        if (thread.mediaType && thread.mediaType.startsWith('video/')) {
          mediaHtml = `<video class='post-video' controls><source src='${thread.image}' type='${thread.mediaType}'>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video>`;
        } else {
          mediaHtml = `<img class='post-image' src='${thread.image}' alt='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' onclick='window.open(this.src)' />`;
        }
      }
      
      threadDiv.innerHTML = `
        <div class="thread-header">
          ${thread.title ? `<div class="thread-title">${escapeHtml(thread.title)}</div>` : ''}
          <div class="thread-meta">
            ${modTag}${testerTag}<span class="op-tag">OP</span> <strong>${escapeHtml(nick)}</strong> 
            | ${new Date(thread.timestamp).toLocaleString('ru-RU')}
          </div>
        </div>
        <div>${escapeHtml(thread.text)}</div>
        ${mediaHtml}
        <div class="reply-count">${replyCount} ${getRepliesWord(replyCount)}</div>
      `;
      
      const repliesContainer = document.createElement('div');
      
      if (thread.replies) {
        const repliesArray = Object.entries(thread.replies).map(([id, reply]) => ({
          firebaseId: id,
          ...reply
        })).sort((a, b) => a.timestamp - b.timestamp);
        
        repliesArray.forEach((reply, replyIndex) => {
          const replyDiv = document.createElement('div');
          replyDiv.className = 'reply-section';
          if (replyIndex >= 3) replyDiv.classList.add('hidden-replies');
          
          let replyMediaHtml = '';
          if (reply.image) {
            if (reply.mediaType && reply.mediaType.startsWith('video/')) {
              replyMediaHtml = `<video class='post-video' controls><source src='${reply.image}' type='${reply.mediaType}'>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video>`;
            } else {
              replyMediaHtml = `<img class='post-image' src='${reply.image}' alt='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' onclick='window.open(this.src)' />`;
            }
          }
          
          const opTag = reply.uid === thread.uid ? '<span class="op-tag">(OP)</span> ' : '';
          const modTag = (reply.isMod && !reply.hideMod) ? '<span class="mod-tag">[MOD]</span> ' : '';
          const testerTag = reply.isTester ? '<span class="tester-tag">[TESTER]</span> ' : '';
          
          replyDiv.innerHTML = `
            <div class="reply-header">
              ${modTag}${testerTag}${opTag}<strong>${escapeHtml(reply.nick)}</strong> 
              | ${new Date(reply.timestamp).toLocaleString('ru-RU')}
            </div>
            <div>${escapeHtml(reply.text)}</div>
            ${replyMediaHtml}
          `;
          
          if (canDeletePost(reply.uid)) {
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
            deleteBtn.className = 'danger';
            deleteBtn.style.fontSize = '0.85em';
            deleteBtn.onclick = () => deleteReply(thread.firebaseId, reply.firebaseId);
            replyDiv.appendChild(deleteBtn);
          }
          
          repliesContainer.appendChild(replyDiv);
        });
        
        if (repliesArray.length > 3) {
          const readMore = document.createElement('span');
          readMore.className = 'read-more';
          readMore.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã (${repliesArray.length})`;
          readMore.onclick = () => {
            const hidden = repliesContainer.querySelectorAll('.hidden-replies');
            const isHidden = hidden[0].style.display !== 'block';
            hidden.forEach(r => r.style.display = isHidden ? 'block' : 'none');
            readMore.textContent = isHidden ? '–°–≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç—ã' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã (${repliesArray.length})`;
          };
          threadDiv.appendChild(repliesContainer);
          threadDiv.appendChild(readMore);
        } else {
          threadDiv.appendChild(repliesContainer);
        }
      }
      
      if (currentUser) {
        const replyForm = document.createElement('div');
        replyForm.className = 'reply-form';
        
        let hideModCheckboxHtml = '';
        if (isMod) {
          hideModCheckboxHtml = `
            <div class="checkbox-group">
              <input type="checkbox" class="reply-hide-mod" id="reply-hide-mod-${thread.firebaseId}">
              <label for="reply-hide-mod-${thread.firebaseId}">üé≠ –°–∫—Ä—ã—Ç—å –ø—Ä–∏–ø–∏—Å–∫—É –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞?</label>
            </div>
          `;
        }
        
        replyForm.innerHTML = `
          <div class="form-group">
            <input type="text" class="reply-nick" placeholder="–ê–Ω–æ–Ω–∏–º">
          </div>
          <div class="form-group">
            <textarea class="reply-text" rows="3" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞"></textarea>
          </div>
          <div class="form-group">
            <input type="file" class="reply-image" accept="image/*,video/mp4,video/webm,image/gif">
          </div>
          ${hideModCheckboxHtml}
        `;
        
        const replyBtn = document.createElement('button');
        replyBtn.textContent = 'üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å';
        replyBtn.onclick = () => {
          const text = replyForm.querySelector('.reply-text').value.trim();
          const imageInput = replyForm.querySelector('.reply-image');
          if (!text && !imageInput.files[0]) {
            showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª!', 'error');
            return;
          }
          showCaptchaModal(() => {
            addReply(thread.firebaseId, thread.uid, replyForm);
          });
        };
        replyForm.appendChild(replyBtn);
        
        threadDiv.appendChild(replyForm);
      }
      
      if (canDeletePost(thread.uid)) {
        const modControls = document.createElement('div');
        modControls.className = 'mod-controls';
        
        const deleteThreadBtn = document.createElement('button');
        deleteThreadBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–¥';
        deleteThreadBtn.className = 'danger';
        deleteThreadBtn.onclick = () => deleteThread(thread.firebaseId);
        
        modControls.appendChild(deleteThreadBtn);
        threadDiv.appendChild(modControls);
      }
      
      container.appendChild(threadDiv);
    });
  });
}

function addReply(threadId, threadUid, formDiv) {
  const nick = formDiv.querySelector('.reply-nick').value.trim() || '–ê–Ω–æ–Ω–∏–º';
  const text = formDiv.querySelector('.reply-text').value.trim();
  const imageInput = formDiv.querySelector('.reply-image');
  const hideModCheckbox = formDiv.querySelector('.reply-hide-mod');
  
  if (!text && !imageInput.files[0]) {
    showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª!', 'error');
    return;
  }
  
const reply = {
    nick: nick,
    text: text,
    uid: currentUser.uid,
    isMod: isMod,
    hideMod: hideModCheckbox ? hideModCheckbox.checked : false,
    isTester: currentUser.isTester,
    timestamp: Date.now(),
    image: null,
    mediaType: null,
    board: currentBoard !== 'all' ? currentBoard : null
  };
  
  if (imageInput.files[0]) {
    const file = imageInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      reply.image = e.target.result;
      reply.mediaType = file.type;
      const replyRef = push(ref(database, `threads/${threadId}/replies`));
      set(replyRef, reply);
      showStatus('–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
      formDiv.querySelector('.reply-text').value = '';
      formDiv.querySelector('.reply-nick').value = '';
      formDiv.querySelector('.reply-image').value = '';
      if (hideModCheckbox) hideModCheckbox.checked = false;
    };
    reader.readAsDataURL(file);
  } else {
    const replyRef = push(ref(database, `threads/${threadId}/replies`));
    set(replyRef, reply);
    showStatus('–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
    formDiv.querySelector('.reply-text').value = '';
    formDiv.querySelector('.reply-nick').value = '';
    if (hideModCheckbox) hideModCheckbox.checked = false;
  }
}

function createThread() {
  const title = document.getElementById('thread-title').value.trim();
  const text = document.getElementById('thread-text').value.trim();
  const imageInput = document.getElementById('thread-image');
  const hideModCheckbox = document.getElementById('thread-hide-mod');
  
  if (!text && !imageInput.files[0]) {
    showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª!', 'error');
    return;
  }
  
showCaptchaModal(() => {
    const nick = document.getElementById('thread-nick').value.trim() || '–ê–Ω–æ–Ω–∏–º';
    
    const thread = {
      title: title,
      text: text,
      nick: nick,
      uid: currentUser.uid,
      isMod: isMod,
      hideMod: hideModCheckbox ? hideModCheckbox.checked : false,
      isTester: currentUser.isTester,
      timestamp: Date.now(),
      image: null,
      mediaType: null,
      board: currentBoard !== 'all' ? currentBoard : null
    };
    
    if (imageInput.files[0]) {
      const file = imageInput.files[0];
      const reader = new FileReader();
      reader.onload = e => {
        thread.image = e.target.result;
        thread.mediaType = file.type;
        const threadRef = push(ref(database, 'threads'));
        set(threadRef, thread);
        showStatus('–¢—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω!');
        
        document.getElementById('thread-title').value = '';
        document.getElementById('thread-text').value = '';
        document.getElementById('thread-image').value = '';
        if (hideModCheckbox) hideModCheckbox.checked = false;
      };
      reader.readAsDataURL(file);
    } else {
      const threadRef = push(ref(database, 'threads'));
      set(threadRef, thread);
      showStatus('–¢—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω!');
      
      document.getElementById('thread-title').value = '';
      document.getElementById('thread-text').value = '';
      if (hideModCheckbox) hideModCheckbox.checked = false;
    }
  });
}

function deleteThread(threadId) {
  showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—Ä–µ–¥?', () => {
    remove(ref(database, `threads/${threadId}`));
    showStatus('–¢—Ä–µ–¥ —É–¥–∞–ª–µ–Ω!');
  });
}

function deleteReply(threadId, replyId) {
  showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç?', () => {
    remove(ref(database, `threads/${threadId}/replies/${replyId}`));
    showStatus('–û—Ç–≤–µ—Ç —É–¥–∞–ª–µ–Ω!');
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

function getRepliesWord(count) {
  if (count % 10 === 1 && count % 100 !== 11) return '–æ—Ç–≤–µ—Ç';
  if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return '–æ—Ç–≤–µ—Ç–∞';
  return '–æ—Ç–≤–µ—Ç–æ–≤';
}

document.getElementById('mod-btn').onclick = () => {
  showModal('password-modal');
  document.getElementById('mod-password-input').value = '';
  document.getElementById('mod-password-input').focus();
};

document.getElementById('submit-password').onclick = () => {
  const pass = document.getElementById('mod-password-input').value;
  if (pass === MOD_PASSWORD) {
    hideModal('password-modal');
    login(true);
    updateBoardsSelector();
  } else {
    showStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!', 'error');
    document.getElementById('mod-password-input').value = '';
    document.getElementById('mod-password-input').focus();
  }
};

document.getElementById('cancel-password').onclick = () => {
  hideModal('password-modal');
};

document.getElementById('mod-password-input').onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('submit-password').click();
  }
};

document.getElementById('user-btn').onclick = () => {
  login(false);
  updateBoardsSelector();
};

document.getElementById('new-thread-btn').onclick = createThread;

document.getElementById('modal-refresh-captcha').onclick = generateCaptcha;

document.getElementById('submit-captcha').onclick = () => {
  if (verifyCaptcha()) {
    hideModal('captcha-modal');
    if (captchaCallback) {
      captchaCallback();
      captchaCallback = null;
    }
  } else {
    showStatus('–ù–µ–≤–µ—Ä–Ω–∞—è –∫–∞–ø—á–∞!', 'error');
    generateCaptcha();
    document.getElementById('modal-captcha-input').focus();
  }
};

document.getElementById('cancel-captcha').onclick = () => {
  hideModal('captcha-modal');
  captchaCallback = null;
  document.getElementById('modal-captcha-input').value = '';
};

document.getElementById('modal-captcha-input').onkeypress = (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('submit-captcha').click();
    return false;
  }
};

document.getElementById('logout-btn').onclick = () => {
  showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?', logout);
};

document.getElementById('settings-btn').onclick = () => {
  showModal('settings-modal');
  updateThemeSelector();
};

document.getElementById('close-settings').onclick = () => {
  hideModal('settings-modal');
};

document.querySelectorAll('.theme-option').forEach(option => {
  option.onclick = () => {
    applyTheme(option.dataset.theme);
  };
});

document.getElementById('cancel-create-board').onclick = () => {
  hideModal('create-board-modal');
};

document.getElementById('submit-create-board').onclick = createBoard;

document.getElementById('board-name-input').onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('submit-create-board').click();
  }
};

document.getElementById('board-title-input').onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('submit-create-board').click();
  }
};

document.getElementById('cancel-edit-board').onclick = () => {
  hideModal('edit-board-modal');
};

document.getElementById('submit-edit-board').onclick = editBoard;

document.getElementById('edit-board-name').onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('submit-edit-board').click();
  }
};

document.getElementById('edit-board-title').onkeypress = (e) => {
  if (e.key === 'Enter') {
    document.getElementById('submit-edit-board').click();
  }
};

document.getElementById('cancel-delete-board').onclick = () => {
  hideModal('delete-board-modal');
};

document.getElementById('submit-delete-board').onclick = deleteBoard;

applyTheme(currentTheme);

if (loadUserSession()) {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('create-thread-section').style.display = 'block';
  document.getElementById('logout-btn').style.display = 'block';
  
  if (isMod) {
    document.getElementById('thread-hide-mod-checkbox').style.display = 'block';
  }
  
  updateBoardsSelector();
}

updateBoardsSelector();
loadThreads();
</script>
</body>
</html>